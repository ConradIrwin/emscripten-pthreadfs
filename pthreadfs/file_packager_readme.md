# PThreadFS File Packager Manual

The PThreadFS file packager adapts [Emscripten's file packager](https://emscripten.org/docs/porting/files/packaging_files.html) for PThreadFS. Support for PThreadFS is activated with the switch `--use-pthreadfs`, e.g.
```
python3 file_packager.py --preload ./input/files@/persistent --use_pthreadfs --js-output=my_package.js my_package.data
```

The packaged files can be loaded into PThreadFS via multiple paths. In the remainder of this manual, `my_package.js` will be the _javascript helper_ file generated by the file packager (i.e., the file specified in the `--js-output=` switch). The generated `mypackage.data` file is called the _package_ and may hold multiple files.

## Howto for common scenarios

### Loading files on startup
If files need to be available before the first file I/O (or very early during the program's execution), they can be loaded as soon as PThreadFS initializes. This can be achieved by running `my_package.js` before the Wasm module is instantiated (e.g. during `--pre-js`).

It is possible to load multiple packages at startup by adding all of their respective javascript helpers before instantiation.

See `examples/preloading.cpp` for an example.

### Loading files during execution (synchronously)
Additional packages can be loaded synchronously during execution by running the following from the WebAssembly module
```c++
#include "pthreadfs.h"
// [other code]
pthreadfs_load_package("my_package.js");
```
This command can also be triggered from the Javascript side by exporting the `pthreadfs_load_package` function. Calling `pthreadfs_load_package` from the Javascript's main thread is *unsupported*, since doing so may block the main thread. See the next section for alternatives.

See `examples/load_package_sync.cpp` for an example.

### Loading files during execution (asynchronously)

It is possible to asynchronously load packages from a Javascript context. The first step is to execute `my_package.js` script (e.g. by using `importScripts()` in workers, or any other method). Right after that, it suffices to run the following code:
```
// This requires a JS context that has defined the `Module` object.
await PThreadFS.init('persistent');
let load_fct = Module["pthreadfs_available_packages"].pop();
await load_fct();
```
Due to limitations of OPFS Access Handles, loading packages from the main thread may be quite slow. The expected slowdown is between 200% and 1000%. The same applies to calling PThreadFS functions such as `PThreadFS.writeFile()` directly. Asynchronously loading files during execution from a worker thread should not experience any slowdown when compared to loading on startup.

See `examples/load_package_async.cpp` for an example.

### Compiling the examples

The examples for the file packager are found in `examples/packager-tests`.
Building the packager tests requires manual creation of the following files:
- packager-tests/input/small/smallfile.txt: Size 188 bytes, first line "These are the contents of a very small file."
- packager-tests/input/mediumlarge/subfolder/mediumfile.txt: Size 138670 bytes, first line "Begin mediumfile.txt -------------------------------------------"
- packager-tests/input/mediumlarge/bigfile.txt: Size 212992000 bytes, first line "Begin bigfile.txt ----------------------------------------------"

After creating these files, the tests can be built by running `make packager-tests`.

## Known limitations
- File packager options `--embed` and `--lz4` cannot be used.
- Asynchronously loading packages is not possible when using the MEMFS backend